/**
 * Opportunity Panel
 * 
 * Displays all identified opportunities for a client engagement,
 * loaded from the database (generated by LLM analysis).
 * 
 * Features:
 * - Grouped by severity (critical, high, medium, low, opportunity)
 * - Expandable cards with full details
 * - Service recommendations with pricing
 * - New service concepts flagged for review
 * - Copy-to-clipboard talking points
 * - Regenerate analysis button
 */

import { useState, useEffect } from 'react';
import { 
  AlertTriangle, 
  TrendingUp, 
  Lightbulb, 
  ChevronDown,
  ChevronRight,
  Copy,
  Check,
  Sparkles,
  RefreshCw,
  Target,
  DollarSign,
  MessageSquare,
  Zap
} from 'lucide-react';
import { supabase } from '../../../lib/supabase';

// ============================================================================
// Types
// ============================================================================

interface Service {
  code: string;
  name: string;
  price_from: number;
  price_to: number;
  price_unit: string;
}

interface Concept {
  id: string;
  suggested_name: string;
  suggested_pricing: string;
  problem_it_solves: string;
  times_identified: number;
}

interface Opportunity {
  id: string;
  opportunity_code: string;
  title: string;
  category: string;
  severity: 'critical' | 'high' | 'medium' | 'low' | 'opportunity';
  data_evidence: string;
  data_values: Record<string, number>;
  benchmark_comparison?: string;
  financial_impact_type?: string;
  financial_impact_amount?: number;
  financial_impact_confidence?: string;
  impact_calculation?: string;
  recommended_service_id?: string;
  service_fit_score?: number;
  service_fit_rationale?: string;
  suggested_concept_id?: string;
  talking_point?: string;
  question_to_ask?: string;
  quick_win?: string;
  life_impact?: string;
  service?: Service;
  concept?: Concept;
  generated_at?: string;
}

interface Props {
  engagementId: string;
}

// ============================================================================
// Styling Configuration
// ============================================================================

const severityConfig = {
  critical: { 
    bg: 'bg-red-50', 
    border: 'border-red-200', 
    badge: 'bg-red-100 text-red-800',
    badgeLabel: 'CRITICAL',
    icon: AlertTriangle,
    iconColor: 'text-red-600'
  },
  high: { 
    bg: 'bg-amber-50', 
    border: 'border-amber-200', 
    badge: 'bg-amber-100 text-amber-800',
    badgeLabel: 'HIGH',
    icon: AlertTriangle,
    iconColor: 'text-amber-600'
  },
  medium: { 
    bg: 'bg-blue-50', 
    border: 'border-blue-200', 
    badge: 'bg-blue-100 text-blue-800',
    badgeLabel: 'MEDIUM',
    icon: TrendingUp,
    iconColor: 'text-blue-600'
  },
  low: { 
    bg: 'bg-slate-50', 
    border: 'border-slate-200', 
    badge: 'bg-slate-100 text-slate-700',
    badgeLabel: 'LOW',
    icon: TrendingUp,
    iconColor: 'text-slate-500'
  },
  opportunity: { 
    bg: 'bg-green-50', 
    border: 'border-green-200', 
    badge: 'bg-green-100 text-green-800',
    badgeLabel: 'OPPORTUNITY',
    icon: Lightbulb,
    iconColor: 'text-green-600'
  },
};

const categoryLabels: Record<string, string> = {
  risk: 'üõ°Ô∏è Risk',
  efficiency: '‚ö° Efficiency',
  growth: 'üìà Growth',
  value: 'üíé Value',
  governance: 'üìã Governance',
  strategic: 'üéØ Strategic',
};

// ============================================================================
// Component
// ============================================================================

export function OpportunityPanel({ engagementId }: Props) {
  const [opportunities, setOpportunities] = useState<Opportunity[]>([]);
  const [loading, setLoading] = useState(true);
  const [regenerating, setRegenerating] = useState(false);
  const [expandedId, setExpandedId] = useState<string | null>(null);
  const [copiedId, setCopiedId] = useState<string | null>(null);
  const [error, setError] = useState<string | null>(null);

  // Load opportunities on mount and when engagementId changes
  useEffect(() => {
    if (engagementId) {
      loadOpportunities();
    }
  }, [engagementId]);

  const loadOpportunities = async () => {
    setLoading(true);
    setError(null);
    
    try {
      const { data, error: fetchError } = await supabase
        .from('client_opportunities')
        .select(`
          *,
          service:services(code, name, price_from, price_to, price_unit),
          concept:service_concepts(id, suggested_name, suggested_pricing, problem_it_solves, times_identified)
        `)
        .eq('engagement_id', engagementId)
        .order('severity');
      
      if (fetchError) throw fetchError;
      
      setOpportunities(data || []);
    } catch (err) {
      console.error('Failed to load opportunities:', err);
      setError('Failed to load opportunities');
    }
    
    setLoading(false);
  };

  const regenerateAnalysis = async () => {
    setRegenerating(true);
    setError(null);
    
    try {
      const response = await supabase.functions.invoke('generate-bm-opportunities', {
        body: { engagementId }
      });
      
      if (response.error) {
        throw new Error(response.error.message || 'Failed to generate opportunities');
      }
      
      // Reload after generation
      await loadOpportunities();
    } catch (err) {
      console.error('Failed to regenerate:', err);
      setError(err instanceof Error ? err.message : 'Failed to regenerate analysis');
    }
    
    setRegenerating(false);
  };

  const copyText = (id: string, text: string) => {
    navigator.clipboard.writeText(text);
    setCopiedId(id);
    setTimeout(() => setCopiedId(null), 2000);
  };

  const formatCurrency = (amount: number): string => {
    if (amount >= 1000000) {
      return `¬£${(amount / 1000000).toFixed(1)}M`;
    }
    if (amount >= 1000) {
      return `¬£${(amount / 1000).toFixed(0)}k`;
    }
    return `¬£${amount.toLocaleString()}`;
  };

  // ============================================================================
  // Render States
  // ============================================================================

  if (loading) {
    return (
      <div className="flex items-center justify-center py-12">
        <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600" />
      </div>
    );
  }

  if (error) {
    return (
      <div className="text-center py-12">
        <AlertTriangle className="w-12 h-12 mx-auto text-red-400 mb-4" />
        <h3 className="text-lg font-medium text-slate-700">Error</h3>
        <p className="text-slate-500 mt-1 mb-4">{error}</p>
        <button
          onClick={regenerateAnalysis}
          disabled={regenerating}
          className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 flex items-center gap-2 mx-auto"
        >
          <RefreshCw className={`w-4 h-4 ${regenerating ? 'animate-spin' : ''}`} />
          Try Again
        </button>
      </div>
    );
  }

  if (opportunities.length === 0) {
    return (
      <div className="text-center py-12">
        <Sparkles className="w-12 h-12 mx-auto text-slate-300 mb-4" />
        <h3 className="text-lg font-medium text-slate-700">Analysis Not Yet Run</h3>
        <p className="text-slate-500 mt-1 mb-4">
          Run the opportunity analysis to identify where we can help this client.
        </p>
        <button
          onClick={regenerateAnalysis}
          disabled={regenerating}
          className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 flex items-center gap-2 mx-auto"
        >
          {regenerating ? (
            <RefreshCw className="w-4 h-4 animate-spin" />
          ) : (
            <Sparkles className="w-4 h-4" />
          )}
          {regenerating ? 'Analysing...' : 'Run Analysis'}
        </button>
      </div>
    );
  }

  // ============================================================================
  // Group and Calculate
  // ============================================================================

  // Group by severity
  const grouped = opportunities.reduce((acc, opp) => {
    const sev = opp.severity || 'low';
    if (!acc[sev]) acc[sev] = [];
    acc[sev].push(opp);
    return acc;
  }, {} as Record<string, Opportunity[]>);

  const severityOrder = ['critical', 'high', 'medium', 'low', 'opportunity'];
  
  // Calculate totals
  const totalValue = opportunities.reduce((sum, o) => sum + (o.financial_impact_amount || 0), 0);
  const criticalCount = (grouped['critical']?.length || 0) + (grouped['high']?.length || 0);
  const quickWins = opportunities.filter(o => o.quick_win).slice(0, 3);
  const newConceptCount = opportunities.filter(o => o.concept).length;

  // ============================================================================
  // Main Render
  // ============================================================================

  return (
    <div className="space-y-6">
      {/* Header with stats and regenerate */}
      <div className="flex items-center justify-between">
        <div className="flex items-center gap-6">
          <div>
            <span className="text-2xl font-bold text-slate-900">{opportunities.length}</span>
            <span className="text-sm text-slate-500 ml-1">opportunities</span>
          </div>
          
          {criticalCount > 0 && (
            <div className="flex items-center gap-1 px-3 py-1 bg-red-100 rounded-full">
              <AlertTriangle className="w-4 h-4 text-red-600" />
              <span className="text-sm font-medium text-red-700">{criticalCount} critical/high</span>
            </div>
          )}
          
          <div className="flex items-center gap-1">
            <DollarSign className="w-4 h-4 text-green-600" />
            <span className="text-sm font-medium text-slate-700">{formatCurrency(totalValue)} total value</span>
          </div>
          
          {newConceptCount > 0 && (
            <div className="flex items-center gap-1 px-3 py-1 bg-purple-100 rounded-full">
              <Sparkles className="w-4 h-4 text-purple-600" />
              <span className="text-sm font-medium text-purple-700">{newConceptCount} new ideas</span>
            </div>
          )}
        </div>
        
        <button
          onClick={regenerateAnalysis}
          disabled={regenerating}
          className="text-sm text-blue-600 hover:text-blue-700 flex items-center gap-1"
        >
          <RefreshCw className={`w-4 h-4 ${regenerating ? 'animate-spin' : ''}`} />
          {regenerating ? 'Analysing...' : 'Regenerate'}
        </button>
      </div>

      {/* Quick Wins Section */}
      {quickWins.length > 0 && (
        <div className="bg-green-50 border border-green-200 rounded-lg p-4">
          <div className="flex items-center gap-2 mb-3">
            <Zap className="w-5 h-5 text-green-600" />
            <h3 className="font-semibold text-green-800">Quick Wins This Week</h3>
          </div>
          <div className="space-y-2">
            {quickWins.map((opp, idx) => (
              <div key={idx} className="flex items-start gap-2">
                <span className="w-5 h-5 bg-green-200 text-green-800 rounded-full flex items-center justify-center text-xs font-bold flex-shrink-0">
                  {idx + 1}
                </span>
                <span className="text-sm text-green-700">{opp.quick_win}</span>
              </div>
            ))}
          </div>
        </div>
      )}

      {/* Summary cards by severity */}
      <div className="grid grid-cols-5 gap-3">
        {severityOrder.map(sev => {
          const config = severityConfig[sev as keyof typeof severityConfig];
          const count = grouped[sev]?.length || 0;
          return (
            <div key={sev} className={`${config.bg} rounded-lg p-3 text-center border ${config.border}`}>
              <div className="text-2xl font-bold text-slate-800">{count}</div>
              <div className={`text-xs font-medium ${config.badge.split(' ')[1]}`}>
                {config.badgeLabel}
              </div>
            </div>
          );
        })}
      </div>

      {/* Opportunities list grouped by severity */}
      {severityOrder.map(severity => {
        const opps = grouped[severity];
        if (!opps?.length) return null;
        
        const config = severityConfig[severity as keyof typeof severityConfig];
        const IconComponent = config.icon;
        
        return (
          <div key={severity} className="space-y-2">
            <h3 className="text-xs font-semibold text-slate-500 uppercase tracking-wide flex items-center gap-2">
              <IconComponent className={`w-4 h-4 ${config.iconColor}`} />
              {severity === 'opportunity' ? 'Opportunities' : `${severity} Priority`}
              <span className="text-slate-400">({opps.length})</span>
            </h3>
            
            {opps.map(opp => (
              <div
                key={opp.id}
                className={`rounded-lg border ${config.border} ${config.bg} overflow-hidden transition-all`}
              >
                {/* Header row - always visible */}
                <button
                  onClick={() => setExpandedId(expandedId === opp.id ? null : opp.id)}
                  className="w-full px-4 py-3 flex items-center justify-between text-left hover:bg-white/30 transition-colors"
                >
                  <div className="flex items-center gap-3 min-w-0">
                    <IconComponent className={`w-5 h-5 ${config.iconColor} flex-shrink-0`} />
                    <div className="min-w-0">
                      <div className="flex items-center gap-2 flex-wrap">
                        <span className={`text-xs px-2 py-0.5 rounded-full ${config.badge}`}>
                          {config.badgeLabel}
                        </span>
                        <span className="text-xs text-slate-500">
                          {categoryLabels[opp.category] || opp.category}
                        </span>
                      </div>
                      <span className="font-medium text-slate-900 block truncate">{opp.title}</span>
                    </div>
                  </div>
                  <div className="flex items-center gap-4 flex-shrink-0">
                    {opp.financial_impact_amount && opp.financial_impact_amount > 0 && (
                      <span className="text-sm font-semibold text-slate-700">
                        {formatCurrency(opp.financial_impact_amount)}
                      </span>
                    )}
                    {expandedId === opp.id ? (
                      <ChevronDown className="w-5 h-5 text-slate-400" />
                    ) : (
                      <ChevronRight className="w-5 h-5 text-slate-400" />
                    )}
                  </div>
                </button>
                
                {/* Expanded content */}
                {expandedId === opp.id && (
                  <div className="px-4 pb-4 space-y-4 border-t border-white/50">
                    {/* Evidence */}
                    <div className="mt-3">
                      <p className="text-sm text-slate-700">{opp.data_evidence}</p>
                      {opp.benchmark_comparison && (
                        <p className="text-xs text-slate-500 mt-1 italic">{opp.benchmark_comparison}</p>
                      )}
                      {opp.impact_calculation && (
                        <p className="text-xs text-slate-400 mt-1">
                          Impact calculation: {opp.impact_calculation}
                        </p>
                      )}
                    </div>
                    
                    {/* Life Impact - what this means for the owner */}
                    {opp.life_impact && (
                      <div className="bg-amber-50 border border-amber-200 rounded-lg p-3">
                        <span className="text-xs font-semibold text-amber-700">FOR THE OWNER: </span>
                        <span className="text-sm text-amber-800">{opp.life_impact}</span>
                      </div>
                    )}
                    
                    {/* Talking point - copyable */}
                    {opp.talking_point && (
                      <div className="bg-white rounded-lg p-3 shadow-sm">
                        <div className="flex items-center justify-between mb-1">
                          <span className="text-xs font-semibold text-blue-600 flex items-center gap-1">
                            <MessageSquare className="w-3 h-3" />
                            SAY THIS:
                          </span>
                          <button
                            onClick={(e) => {
                              e.stopPropagation();
                              copyText(`talk-${opp.id}`, opp.talking_point!);
                            }}
                            className="text-slate-400 hover:text-slate-600 p-1"
                            title="Copy to clipboard"
                          >
                            {copiedId === `talk-${opp.id}` ? (
                              <Check className="w-4 h-4 text-green-500" />
                            ) : (
                              <Copy className="w-4 h-4" />
                            )}
                          </button>
                        </div>
                        <p className="text-sm text-slate-700 italic">"{opp.talking_point}"</p>
                      </div>
                    )}
                    
                    {/* Discovery question */}
                    {opp.question_to_ask && (
                      <div className="bg-blue-50 rounded-lg p-3">
                        <span className="text-xs font-semibold text-blue-700">ASK: </span>
                        <span className="text-sm text-blue-700">"{opp.question_to_ask}"</span>
                      </div>
                    )}
                    
                    {/* Quick win */}
                    {opp.quick_win && (
                      <div className="bg-green-100 rounded-lg p-3 flex items-start gap-2">
                        <Zap className="w-4 h-4 text-green-600 flex-shrink-0 mt-0.5" />
                        <div>
                          <span className="text-xs font-semibold text-green-800">QUICK WIN: </span>
                          <span className="text-sm text-green-700">{opp.quick_win}</span>
                        </div>
                      </div>
                    )}
                    
                    {/* Service recommendation */}
                    {opp.service && (
                      <div className="bg-white rounded-lg p-3 shadow-sm border border-slate-200">
                        <div className="flex items-start justify-between">
                          <div className="flex items-start gap-2">
                            <Target className="w-4 h-4 text-indigo-600 mt-0.5" />
                            <div>
                              <span className="text-xs text-slate-500">RECOMMEND:</span>
                              <div className="font-medium text-slate-900">{opp.service.name}</div>
                              {opp.service_fit_rationale && (
                                <p className="text-sm text-slate-600 mt-1">{opp.service_fit_rationale}</p>
                              )}
                            </div>
                          </div>
                          <div className="text-right flex-shrink-0">
                            <div className="font-semibold text-slate-800">
                              ¬£{opp.service.price_from}
                              {opp.service.price_to !== opp.service.price_from && `-${opp.service.price_to}`}
                              <span className="text-xs text-slate-500">{opp.service.price_unit}</span>
                            </div>
                            {opp.service_fit_score && (
                              <span className={`text-xs px-2 py-0.5 rounded-full ${
                                opp.service_fit_score >= 80 
                                  ? 'bg-green-100 text-green-700'
                                  : opp.service_fit_score >= 60
                                  ? 'bg-blue-100 text-blue-700'
                                  : 'bg-slate-100 text-slate-600'
                              }`}>
                                {opp.service_fit_score}% fit
                              </span>
                            )}
                          </div>
                        </div>
                      </div>
                    )}
                    
                    {/* New concept suggestion */}
                    {opp.concept && (
                      <div className="bg-purple-50 rounded-lg p-3 border border-purple-200">
                        <div className="flex items-center gap-2 mb-2">
                          <Sparkles className="w-4 h-4 text-purple-600" />
                          <span className="text-xs font-semibold text-purple-800">
                            NEW SERVICE CONCEPT
                          </span>
                          {opp.concept.times_identified > 1 && (
                            <span className="text-xs px-2 py-0.5 rounded-full bg-purple-200 text-purple-800">
                              Seen {opp.concept.times_identified}√ó across clients
                            </span>
                          )}
                        </div>
                        <div className="font-medium text-purple-900">{opp.concept.suggested_name}</div>
                        <p className="text-sm text-purple-700 mt-1">{opp.concept.problem_it_solves}</p>
                        {opp.concept.suggested_pricing && (
                          <div className="text-xs text-purple-600 mt-2 font-medium">
                            Suggested pricing: {opp.concept.suggested_pricing}
                          </div>
                        )}
                      </div>
                    )}
                  </div>
                )}
              </div>
            ))}
          </div>
        );
      })}
    </div>
  );
}

