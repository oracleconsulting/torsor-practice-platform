/**
 * Opportunity Panel
 * 
 * Displays all identified opportunities for a client engagement,
 * loaded from the database (generated by LLM analysis).
 * 
 * Features:
 * - Grouped by severity (critical, high, medium, low, opportunity)
 * - Expandable cards with full details
 * - Service recommendations with pricing
 * - New service concepts flagged for review
 * - Copy-to-clipboard talking points
 * - Regenerate analysis button
 */

import { useState, useEffect } from 'react';
import { 
  AlertTriangle, 
  TrendingUp, 
  Lightbulb, 
  ChevronDown,
  ChevronRight,
  Copy,
  Check,
  Sparkles,
  RefreshCw,
  Target,
  DollarSign,
  MessageSquare,
  Zap,
  Plus,
  Loader2
} from 'lucide-react';
import { supabase } from '../../../lib/supabase';
import { ServiceCreationModal } from './ServiceCreationModal';

// ============================================================================
// Types
// ============================================================================

interface Service {
  code: string;
  name: string;
  price_from: number;
  price_to: number;
  price_unit: string;
}

interface Concept {
  id: string;
  suggested_name: string;
  suggested_pricing: string;
  problem_it_solves: string;
  times_identified: number;
}

interface Opportunity {
  id: string;
  opportunity_code: string;
  title: string;
  category: string;
  severity: 'critical' | 'high' | 'medium' | 'low' | 'opportunity';
  // NEW: Priority fields from direction-aware processing
  priority?: 'must_address_now' | 'next_12_months' | 'when_ready';
  priority_rationale?: string;
  priority_adjusted?: boolean;
  consolidated_from?: string[];
  for_the_owner?: string;
  display_order?: number;
  // End new fields
  data_evidence: string;
  data_values: Record<string, number>;
  benchmark_comparison?: string;
  financial_impact_type?: string;
  financial_impact_amount?: number;
  financial_impact_confidence?: string;
  impact_calculation?: string;
  recommended_service_id?: string;
  service_fit_score?: number;
  service_fit_rationale?: string;
  suggested_concept_id?: string;
  talking_point?: string;
  question_to_ask?: string;
  quick_win?: string;
  life_impact?: string;
  service?: Service;
  concept?: Concept;
  generated_at?: string;
}

interface Props {
  engagementId: string;
  clientId?: string;
  practiceId?: string;
  userId?: string;
}

// ============================================================================
// Styling Configuration
// ============================================================================

const severityConfig = {
  critical: { 
    bg: 'bg-red-50', 
    border: 'border-red-200', 
    badge: 'bg-red-100 text-red-800',
    badgeLabel: 'CRITICAL',
    icon: AlertTriangle,
    iconColor: 'text-red-600'
  },
  high: { 
    bg: 'bg-amber-50', 
    border: 'border-amber-200', 
    badge: 'bg-amber-100 text-amber-800',
    badgeLabel: 'HIGH',
    icon: AlertTriangle,
    iconColor: 'text-amber-600'
  },
  medium: { 
    bg: 'bg-blue-50', 
    border: 'border-blue-200', 
    badge: 'bg-blue-100 text-blue-800',
    badgeLabel: 'MEDIUM',
    icon: TrendingUp,
    iconColor: 'text-blue-600'
  },
  low: { 
    bg: 'bg-slate-50', 
    border: 'border-slate-200', 
    badge: 'bg-slate-100 text-slate-700',
    badgeLabel: 'LOW',
    icon: TrendingUp,
    iconColor: 'text-slate-500'
  },
  opportunity: { 
    bg: 'bg-green-50', 
    border: 'border-green-200', 
    badge: 'bg-green-100 text-green-800',
    badgeLabel: 'OPPORTUNITY',
    icon: Lightbulb,
    iconColor: 'text-green-600'
  },
};

const categoryLabels: Record<string, string> = {
  risk: 'üõ°Ô∏è Risk',
  efficiency: '‚ö° Efficiency',
  growth: 'üìà Growth',
  value: 'üíé Value',
  governance: 'üìã Governance',
  strategic: 'üéØ Strategic',
};

// Priority-based styling (new grouping for direction-aware display)
const priorityConfig = {
  must_address_now: {
    bg: 'bg-red-50',
    border: 'border-red-200',
    headerBg: 'bg-red-100',
    title: 'üö® Must Address Now',
    subtitle: 'These block your stated goal',
    textColor: 'text-red-800',
  },
  next_12_months: {
    bg: 'bg-amber-50',
    border: 'border-amber-200',
    headerBg: 'bg-amber-100',
    title: 'üìÖ Address in Next 12 Months',
    subtitle: 'Important but not blocking',
    textColor: 'text-amber-800',
  },
  when_ready: {
    bg: 'bg-green-50',
    border: 'border-green-200',
    headerBg: 'bg-green-100',
    title: 'üí° Consider When Ready',
    subtitle: 'Optimisation opportunities',
    textColor: 'text-green-800',
  },
};

const directionLabels: Record<string, string> = {
  'grow_aggressive': 'üöÄ Aggressive Growth',
  'Grow aggressively - acquisitions, new markets, scale significantly': 'üöÄ Aggressive Growth',
  'grow_steady': 'üìà Steady Growth',
  'Grow steadily - organic growth, same market, manageable pace': 'üìà Steady Growth',
  'maintain_optimise': '‚öôÔ∏è Maintain & Optimise',
  'Maintain and optimise - protect position, improve margins': '‚öôÔ∏è Maintain & Optimise',
  'step_back': 'üèñÔ∏è Step Back',
  'Step back - reduce my involvement, more lifestyle-focused': 'üèñÔ∏è Step Back',
  'prepare_exit': 'üéØ Prepare for Exit',
  'Prepare for exit - sale, succession, retirement': 'üéØ Prepare for Exit',
  'unsure': 'ü§î Exploring Options',
  "Unsure - I'm exploring my options": 'ü§î Exploring Options',
};

// ============================================================================
// Component
// ============================================================================

export function OpportunityPanel({ engagementId, clientId, practiceId, userId: propUserId }: Props) {
  const [opportunities, setOpportunities] = useState<Opportunity[]>([]);
  const [loading, setLoading] = useState(true);
  const [regenerating, setRegenerating] = useState(false);
  const [regenerateSeconds, setRegenerateSeconds] = useState(0);
  const [expandedId, setExpandedId] = useState<string | null>(null);
  const [copiedId, setCopiedId] = useState<string | null>(null);
  const [error, setError] = useState<string | null>(null);
  
  // Service creation state
  const [creatingServiceFor, setCreatingServiceFor] = useState<string | null>(null);
  const [serviceCreationRequestId, setServiceCreationRequestId] = useState<string | null>(null);
  const [showCreationModal, setShowCreationModal] = useState(false);
  const [currentUserId, setCurrentUserId] = useState<string | null>(propUserId || null);
  
  // Get current user if not provided
  useEffect(() => {
    if (!propUserId) {
      supabase.auth.getUser().then(({ data }) => {
        if (data?.user?.id) {
          setCurrentUserId(data.user.id);
        }
      });
    }
  }, [propUserId]);
  
  const userId = propUserId || currentUserId;
  
  // Timer for regeneration progress
  useEffect(() => {
    let interval: ReturnType<typeof setInterval> | undefined;
    if (regenerating) {
      setRegenerateSeconds(0);
      interval = setInterval(() => {
        setRegenerateSeconds(s => s + 1);
      }, 1000);
    }
    return () => {
      if (interval) clearInterval(interval);
    };
  }, [regenerating]);

  // Load opportunities on mount and when engagementId changes
  useEffect(() => {
    if (engagementId) {
      loadOpportunities();
    }
  }, [engagementId]);

  // Handle creating a service from an opportunity
  const handleCreateService = async (opportunityId: string, conceptId?: string) => {
    if (!practiceId || !userId) {
      alert('Missing practice or user information');
      return;
    }
    
    setCreatingServiceFor(opportunityId);
    
    try {
      const supabaseUrl = import.meta.env.VITE_SUPABASE_URL;
      const supabaseKey = import.meta.env.VITE_SUPABASE_ANON_KEY;
      
      const response = await fetch(`${supabaseUrl}/functions/v1/create-service-from-opportunity`, {
        method: 'POST',
        headers: {
          'Authorization': `Bearer ${supabaseKey}`,
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          opportunityId: conceptId ? undefined : opportunityId,
          conceptId: conceptId || undefined,
          engagementId,
          clientId,
          practiceId,
          requestedBy: userId,
        }),
      });
      
      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.error || 'Failed to create service proposal');
      }
      
      const result = await response.json();
      
      if (result.success && result.requestId) {
        setServiceCreationRequestId(result.requestId);
        setShowCreationModal(true);
      }
    } catch (err: any) {
      console.error('Failed to create service:', err);
      alert(`Error: ${err.message}`);
    }
    
    setCreatingServiceFor(null);
  };
  
  const handleServiceApproved = () => {
    setShowCreationModal(false);
    setServiceCreationRequestId(null);
    // Reload opportunities to see updated data
    loadOpportunities();
  };

  const loadOpportunities = async () => {
    setLoading(true);
    setError(null);
    
    try {
      const { data, error: fetchError } = await supabase
        .from('client_opportunities')
        .select(`
          *,
          service:services(code, name, price_from, price_to, price_unit),
          concept:service_concepts(id, suggested_name, suggested_pricing, problem_it_solves, times_identified)
        `)
        .eq('engagement_id', engagementId)
        .order('display_order', { ascending: true });
      
      if (fetchError) throw fetchError;
      
      setOpportunities(data || []);
    } catch (err) {
      console.error('Failed to load opportunities:', err);
      setError('Failed to load opportunities');
    }
    
    setLoading(false);
  };

  const regenerateAnalysis = async () => {
    setRegenerating(true);
    setError(null);
    
    try {
      // Use fetch directly with 3-minute timeout (Opus 4.5 can take ~2 minutes)
      const controller = new AbortController();
      const timeoutId = setTimeout(() => controller.abort(), 180000); // 3 minutes
      
      const supabaseUrl = import.meta.env.VITE_SUPABASE_URL;
      const supabaseKey = import.meta.env.VITE_SUPABASE_ANON_KEY;
      
      const response = await fetch(
        `${supabaseUrl}/functions/v1/generate-bm-opportunities`,
        {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            'Authorization': `Bearer ${supabaseKey}`,
          },
          body: JSON.stringify({ engagementId }),
          signal: controller.signal,
        }
      );
      
      clearTimeout(timeoutId);
      
      if (!response.ok) {
        const errorData = await response.json().catch(() => ({}));
        throw new Error(errorData.error || `HTTP ${response.status}`);
      }
      
      // Reload after generation
      await loadOpportunities();
    } catch (err) {
      console.error('Failed to regenerate:', err);
      if (err instanceof Error && err.name === 'AbortError') {
        setError('Analysis timed out. The AI is still processing - try refreshing in a minute.');
      } else {
        setError(err instanceof Error ? err.message : 'Failed to regenerate analysis');
      }
    }
    
    setRegenerating(false);
  };

  const copyText = (id: string, text: string) => {
    navigator.clipboard.writeText(text);
    setCopiedId(id);
    setTimeout(() => setCopiedId(null), 2000);
  };

  const formatCurrency = (amount: number): string => {
    if (amount >= 1000000) {
      return `¬£${(amount / 1000000).toFixed(1)}M`;
    }
    if (amount >= 1000) {
      return `¬£${(amount / 1000).toFixed(0)}k`;
    }
    return `¬£${amount.toLocaleString()}`;
  };

  // ============================================================================
  // Render States
  // ============================================================================

  if (loading) {
    return (
      <div className="flex items-center justify-center py-12">
        <div className="animate-spin rounded-full h-8 w-8 border-b-2 border-blue-600" />
      </div>
    );
  }

  if (error) {
    return (
      <div className="text-center py-12">
        <AlertTriangle className="w-12 h-12 mx-auto text-red-400 mb-4" />
        <h3 className="text-lg font-medium text-slate-700">Error</h3>
        <p className="text-slate-500 mt-1 mb-4">{error}</p>
        <button
          onClick={regenerateAnalysis}
          disabled={regenerating}
          className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 flex items-center gap-2 mx-auto"
        >
          <RefreshCw className={`w-4 h-4 ${regenerating ? 'animate-spin' : ''}`} />
          Try Again
        </button>
      </div>
    );
  }

  if (opportunities.length === 0) {
    return (
      <div className="text-center py-12">
        <Sparkles className={`w-12 h-12 mx-auto mb-4 ${regenerating ? 'text-blue-500 animate-pulse' : 'text-slate-300'}`} />
        <h3 className="text-lg font-medium text-slate-700">
          {regenerating ? 'Analysing with Claude Opus...' : 'Analysis Not Yet Run'}
        </h3>
        <p className="text-slate-500 mt-1 mb-4">
          {regenerating 
            ? `Deep analysis in progress. This typically takes 1-2 minutes. (${regenerateSeconds}s)`
            : 'Run the opportunity analysis to identify where we can help this client.'
          }
        </p>
        {regenerating && regenerateSeconds > 60 && (
          <p className="text-xs text-slate-400 mb-4">
            Still working... Opus is thorough. Nearly there.
          </p>
        )}
        <button
          onClick={regenerateAnalysis}
          disabled={regenerating}
          className="px-4 py-2 bg-blue-600 text-white rounded-lg hover:bg-blue-700 disabled:opacity-50 flex items-center gap-2 mx-auto"
        >
          {regenerating ? (
            <RefreshCw className="w-4 h-4 animate-spin" />
          ) : (
            <Sparkles className="w-4 h-4" />
          )}
          {regenerating ? `Analysing... (${regenerateSeconds}s)` : 'Run Analysis'}
        </button>
      </div>
    );
  }

  // ============================================================================
  // Group and Calculate
  // ============================================================================

  // Group by priority (new direction-aware grouping)
  const groupedByPriority = opportunities.reduce((acc, opp) => {
    const pri = opp.priority || 'next_12_months';
    if (!acc[pri]) acc[pri] = [];
    acc[pri].push(opp);
    return acc;
  }, {} as Record<string, Opportunity[]>);

  const priorityOrder = ['must_address_now', 'next_12_months', 'when_ready'] as const;

  // Also group by severity for the summary cards
  const grouped = opportunities.reduce((acc, opp) => {
    const sev = opp.severity || 'low';
    if (!acc[sev]) acc[sev] = [];
    acc[sev].push(opp);
    return acc;
  }, {} as Record<string, Opportunity[]>);

  const severityOrder = ['critical', 'high', 'medium', 'low', 'opportunity'];
  
  // Calculate totals
  const totalValue = opportunities.reduce((sum, o) => sum + (o.financial_impact_amount || 0), 0);
  const criticalCount = (grouped['critical']?.length || 0) + (grouped['high']?.length || 0);
  const mustAddressCount = groupedByPriority['must_address_now']?.length || 0;
  const quickWins = opportunities.filter(o => o.quick_win).slice(0, 3);
  const newConceptCount = opportunities.filter(o => o.concept).length;
  
  // Get client direction from the first opportunity (they all have the same context)
  const clientDirection = opportunities[0]?.priority_rationale?.match(/"([^"]+)" business direction/)?.[1] || null;

  // ============================================================================
  // Main Render
  // ============================================================================

  return (
    <div className="space-y-6">
      {/* Direction Context Banner */}
      {clientDirection && (
        <div className="bg-blue-50 border border-blue-200 rounded-lg p-3 flex items-center justify-between">
          <div>
            <span className="text-sm font-medium text-blue-800">
              Client Direction: {directionLabels[clientDirection] || clientDirection}
            </span>
            <p className="text-xs text-blue-600 mt-0.5">
              Priorities automatically adjusted based on stated business direction
            </p>
          </div>
        </div>
      )}

      {/* Header with stats and regenerate */}
      <div className="flex items-center justify-between">
        <div className="flex items-center gap-6">
          <div>
            <span className="text-2xl font-bold text-slate-900">{opportunities.length}</span>
            <span className="text-sm text-slate-500 ml-1">opportunities</span>
          </div>
          
          {mustAddressCount > 0 && (
            <div className="flex items-center gap-1 px-3 py-1 bg-red-100 rounded-full">
              <AlertTriangle className="w-4 h-4 text-red-600" />
              <span className="text-sm font-medium text-red-700">{mustAddressCount} must address now</span>
            </div>
          )}
          
          <div className="flex items-center gap-1">
            <DollarSign className="w-4 h-4 text-green-600" />
            <span className="text-sm font-medium text-slate-700">{formatCurrency(totalValue)} total value</span>
          </div>
          
          {newConceptCount > 0 && (
            <div className="flex items-center gap-1 px-3 py-1 bg-purple-100 rounded-full">
              <Sparkles className="w-4 h-4 text-purple-600" />
              <span className="text-sm font-medium text-purple-700">{newConceptCount} new ideas</span>
            </div>
          )}
        </div>
        
        <button
          onClick={regenerateAnalysis}
          disabled={regenerating}
          className="text-sm text-blue-600 hover:text-blue-700 flex items-center gap-1"
        >
          <RefreshCw className={`w-4 h-4 ${regenerating ? 'animate-spin' : ''}`} />
          {regenerating ? `Analysing... (${regenerateSeconds}s)` : 'Regenerate'}
        </button>
      </div>

      {/* Quick Wins Section */}
      {quickWins.length > 0 && (
        <div className="bg-green-50 border border-green-200 rounded-lg p-4">
          <div className="flex items-center gap-2 mb-3">
            <Zap className="w-5 h-5 text-green-600" />
            <h3 className="font-semibold text-green-800">Quick Wins This Week</h3>
          </div>
          <div className="space-y-2">
            {quickWins.map((opp, idx) => (
              <div key={idx} className="flex items-start gap-2">
                <span className="w-5 h-5 bg-green-200 text-green-800 rounded-full flex items-center justify-center text-xs font-bold flex-shrink-0">
                  {idx + 1}
                </span>
                <span className="text-sm text-green-700">{opp.quick_win}</span>
              </div>
            ))}
          </div>
        </div>
      )}

      {/* Summary cards by priority (new direction-aware display) */}
      <div className="grid grid-cols-3 gap-3">
        {priorityOrder.map(pri => {
          const config = priorityConfig[pri];
          const count = groupedByPriority[pri]?.length || 0;
          const value = (groupedByPriority[pri] || []).reduce((sum, o) => sum + (o.financial_impact_amount || 0), 0);
          return (
            <div key={pri} className={`${config.bg} rounded-lg p-4 border ${config.border}`}>
              <div className="flex items-center justify-between">
                <div className="text-3xl font-bold text-slate-800">{count}</div>
                {value > 0 && (
                  <div className="text-sm font-medium text-slate-600">{formatCurrency(value)}</div>
                )}
              </div>
              <div className={`text-sm font-medium ${config.textColor} mt-1`}>
                {config.title.replace(/^[^\s]+\s/, '')}
              </div>
              <div className="text-xs text-slate-500 mt-0.5">{config.subtitle}</div>
            </div>
          );
        })}
      </div>

      {/* Opportunities list grouped by priority */}
      {priorityOrder.map(priority => {
        const opps = groupedByPriority[priority];
        if (!opps?.length) return null;
        
        const config = priorityConfig[priority];
        
        return (
          <div key={priority} className={`rounded-lg border ${config.border} overflow-hidden`}>
            {/* Priority Group Header */}
            <div className={`${config.headerBg} px-4 py-3 border-b ${config.border}`}>
              <h3 className={`font-semibold ${config.textColor}`}>{config.title}</h3>
              <p className="text-sm text-slate-600">{config.subtitle}</p>
            </div>
            
            {/* Opportunities in this priority group */}
            <div className="divide-y divide-slate-100">
            {opps.map(opp => {
              const sevConfig = severityConfig[opp.severity as keyof typeof severityConfig];
              const IconComponent = sevConfig.icon;
              
              return (
              <div
                key={opp.id}
                className="bg-white overflow-hidden transition-all"
              >
                {/* Header row - always visible */}
                <button
                  onClick={() => setExpandedId(expandedId === opp.id ? null : opp.id)}
                  className="w-full px-4 py-3 flex items-center justify-between text-left hover:bg-slate-50 transition-colors"
                >
                  <div className="flex items-center gap-3 min-w-0">
                    <IconComponent className={`w-5 h-5 ${sevConfig.iconColor} flex-shrink-0`} />
                    <div className="min-w-0">
                      <div className="flex items-center gap-2 flex-wrap">
                        <span className={`text-xs px-2 py-0.5 rounded-full ${sevConfig.badge}`}>
                          {sevConfig.badgeLabel}
                        </span>
                        <span className="text-xs text-slate-500">
                          {categoryLabels[opp.category] || opp.category}
                        </span>
                        {opp.priority_adjusted && (
                          <span className="text-xs text-blue-500" title={opp.priority_rationale}>
                            ‚ö° Priority adjusted
                          </span>
                        )}
                      </div>
                      <span className="font-medium text-slate-900 block truncate">{opp.title}</span>
                    </div>
                  </div>
                  <div className="flex items-center gap-4 flex-shrink-0">
                    {opp.financial_impact_amount && opp.financial_impact_amount > 0 && (
                      <span className="text-sm font-semibold text-slate-700">
                        {formatCurrency(opp.financial_impact_amount)}
                      </span>
                    )}
                    {expandedId === opp.id ? (
                      <ChevronDown className="w-5 h-5 text-slate-400" />
                    ) : (
                      <ChevronRight className="w-5 h-5 text-slate-400" />
                    )}
                  </div>
                </button>
                
                {/* Expanded content */}
                {expandedId === opp.id && (
                  <div className="px-4 pb-4 space-y-4 border-t border-white/50">
                    {/* Evidence */}
                    <div className="mt-3">
                      <p className="text-sm text-slate-700">{opp.data_evidence}</p>
                      {opp.benchmark_comparison && (
                        <p className="text-xs text-slate-500 mt-1 italic">{opp.benchmark_comparison}</p>
                      )}
                      {opp.impact_calculation && (
                        <p className="text-xs text-slate-400 mt-1">
                          Impact calculation: {opp.impact_calculation}
                        </p>
                      )}
                    </div>
                    
                    {/* Life Impact - what this means for the owner */}
                    {opp.life_impact && (
                      <div className="bg-amber-50 border border-amber-200 rounded-lg p-3">
                        <span className="text-xs font-semibold text-amber-700">FOR THE OWNER: </span>
                        <span className="text-sm text-amber-800">{opp.life_impact}</span>
                      </div>
                    )}
                    
                    {/* Talking point - copyable */}
                    {opp.talking_point && (
                      <div className="bg-white rounded-lg p-3 shadow-sm">
                        <div className="flex items-center justify-between mb-1">
                          <span className="text-xs font-semibold text-blue-600 flex items-center gap-1">
                            <MessageSquare className="w-3 h-3" />
                            SAY THIS:
                          </span>
                          <button
                            onClick={(e) => {
                              e.stopPropagation();
                              copyText(`talk-${opp.id}`, opp.talking_point!);
                            }}
                            className="text-slate-400 hover:text-slate-600 p-1"
                            title="Copy to clipboard"
                          >
                            {copiedId === `talk-${opp.id}` ? (
                              <Check className="w-4 h-4 text-green-500" />
                            ) : (
                              <Copy className="w-4 h-4" />
                            )}
                          </button>
                        </div>
                        <p className="text-sm text-slate-700 italic">"{opp.talking_point}"</p>
                      </div>
                    )}
                    
                    {/* Discovery question */}
                    {opp.question_to_ask && (
                      <div className="bg-blue-50 rounded-lg p-3">
                        <span className="text-xs font-semibold text-blue-700">ASK: </span>
                        <span className="text-sm text-blue-700">"{opp.question_to_ask}"</span>
                      </div>
                    )}
                    
                    {/* Quick win */}
                    {opp.quick_win && (
                      <div className="bg-green-100 rounded-lg p-3 flex items-start gap-2">
                        <Zap className="w-4 h-4 text-green-600 flex-shrink-0 mt-0.5" />
                        <div>
                          <span className="text-xs font-semibold text-green-800">QUICK WIN: </span>
                          <span className="text-sm text-green-700">{opp.quick_win}</span>
                        </div>
                      </div>
                    )}
                    
                    {/* Service recommendation */}
                    {opp.service && (
                      <div className="bg-white rounded-lg p-3 shadow-sm border border-slate-200">
                        <div className="flex items-start justify-between">
                          <div className="flex items-start gap-2">
                            <Target className="w-4 h-4 text-indigo-600 mt-0.5" />
                            <div>
                              <span className="text-xs text-slate-500">RECOMMEND:</span>
                              <div className="font-medium text-slate-900">{opp.service.name}</div>
                              {opp.service_fit_rationale && (
                                <p className="text-sm text-slate-600 mt-1">{opp.service_fit_rationale}</p>
                              )}
                            </div>
                          </div>
                          <div className="text-right flex-shrink-0">
                            <div className="font-semibold text-slate-800">
                              ¬£{opp.service.price_from}
                              {opp.service.price_to !== opp.service.price_from && `-${opp.service.price_to}`}
                              <span className="text-xs text-slate-500">{opp.service.price_unit}</span>
                            </div>
                            {opp.service_fit_score && (
                              <span className={`text-xs px-2 py-0.5 rounded-full ${
                                opp.service_fit_score >= 80 
                                  ? 'bg-green-100 text-green-700'
                                  : opp.service_fit_score >= 60
                                  ? 'bg-blue-100 text-blue-700'
                                  : 'bg-slate-100 text-slate-600'
                              }`}>
                                {opp.service_fit_score}% fit
                              </span>
                            )}
                          </div>
                        </div>
                      </div>
                    )}
                    
                    {/* New concept suggestion */}
                    {opp.concept && (
                      <div className="bg-purple-50 rounded-lg p-3 border border-purple-200">
                        <div className="flex items-center justify-between mb-2">
                          <div className="flex items-center gap-2">
                            <Sparkles className="w-4 h-4 text-purple-600" />
                            <span className="text-xs font-semibold text-purple-800">
                              NEW SERVICE CONCEPT
                            </span>
                            {opp.concept.times_identified > 1 && (
                              <span className="text-xs px-2 py-0.5 rounded-full bg-purple-200 text-purple-800">
                                Seen {opp.concept.times_identified}√ó across clients
                              </span>
                            )}
                          </div>
                          {practiceId && userId && (
                            <button
                              onClick={(e) => {
                                e.stopPropagation();
                                handleCreateService(opp.id, opp.concept?.id);
                              }}
                              disabled={creatingServiceFor === opp.id}
                              className="flex items-center gap-1 px-3 py-1 text-xs font-medium bg-purple-600 text-white rounded hover:bg-purple-700 disabled:opacity-50"
                            >
                              {creatingServiceFor === opp.id ? (
                                <Loader2 className="w-3 h-3 animate-spin" />
                              ) : (
                                <Plus className="w-3 h-3" />
                              )}
                              Create Service
                            </button>
                          )}
                        </div>
                        <div className="font-medium text-purple-900">{opp.concept.suggested_name}</div>
                        <p className="text-sm text-purple-700 mt-1">{opp.concept.problem_it_solves}</p>
                        {opp.concept.suggested_pricing && (
                          <div className="text-xs text-purple-600 mt-2 font-medium">
                            Suggested pricing: {opp.concept.suggested_pricing}
                          </div>
                        )}
                      </div>
                    )}
                    
                    {/* Create service button when no existing service matches */}
                    {!opp.service && !opp.concept && practiceId && userId && (
                      <button
                        onClick={(e) => {
                          e.stopPropagation();
                          handleCreateService(opp.id);
                        }}
                        disabled={creatingServiceFor === opp.id}
                        className="w-full flex items-center justify-center gap-2 px-4 py-2 text-sm font-medium text-indigo-600 bg-indigo-50 rounded-lg hover:bg-indigo-100 border border-indigo-200 disabled:opacity-50"
                      >
                        {creatingServiceFor === opp.id ? (
                          <>
                            <Loader2 className="w-4 h-4 animate-spin" />
                            Generating service proposal...
                          </>
                        ) : (
                          <>
                            <Plus className="w-4 h-4" />
                            Create New Service for This Opportunity
                          </>
                        )}
                      </button>
                    )}
                  </div>
                )}
              </div>
              );
            })}
            </div>
          </div>
        );
      })}
      
      {/* Service Creation Modal */}
      {showCreationModal && serviceCreationRequestId && (
        <ServiceCreationModal
          requestId={serviceCreationRequestId}
          onClose={() => {
            setShowCreationModal(false);
            setServiceCreationRequestId(null);
          }}
          onApproved={handleServiceApproved}
        />
      )}
    </div>
  );
}

