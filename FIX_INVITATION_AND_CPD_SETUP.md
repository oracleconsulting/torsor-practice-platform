# üîß Fix Invitation System & Add CPD Configuration

## Issues to Fix
1. ‚ùå **Invitations table doesn't exist** - `relation "public.invitations" does not exist`
2. ‚ùå **Infinite recursion in RLS** - `infinite recursion detected in policy for relation "practice_members"`
3. ‚ùå **No CPD configuration** - Need to add CPD hours tracking for admin

---

## üéØ Solution: Run 3 SQL Migrations

### Step 1: Open Supabase SQL Editor
1. Go to: https://supabase.com/dashboard/project/nwmzegonnmqzflamcxfd/sql/new
2. You'll run 3 migrations in order

---

## Migration 1: Fix RLS Infinite Recursion

**Copy and paste this entire script:**

```sql
-- =====================================================
-- FIX: Infinite recursion in practice_members RLS
-- =====================================================

-- Drop any existing problematic policies on practice_members
DROP POLICY IF EXISTS "Users can view own practice members" ON practice_members;
DROP POLICY IF EXISTS "Users can view practice members" ON practice_members;
DROP POLICY IF EXISTS "Practice members can view themselves" ON practice_members;
DROP POLICY IF EXISTS "Practice members can view team" ON practice_members;

-- Create SECURITY DEFINER function to bypass RLS and prevent recursion
CREATE OR REPLACE FUNCTION is_practice_member(p_user_id UUID, p_practice_id UUID)
RETURNS BOOLEAN AS $$
DECLARE
  member_exists BOOLEAN;
BEGIN
  SELECT EXISTS(
    SELECT 1 FROM practice_members 
    WHERE user_id = p_user_id 
    AND practice_id = p_practice_id
  ) INTO member_exists;
  
  RETURN member_exists;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

CREATE OR REPLACE FUNCTION get_user_practice_ids(p_user_id UUID)
RETURNS TABLE(practice_id UUID) AS $$
BEGIN
  RETURN QUERY
  SELECT pm.practice_id 
  FROM practice_members pm
  WHERE pm.user_id = p_user_id;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

-- Enable RLS
ALTER TABLE practice_members ENABLE ROW LEVEL SECURITY;

-- Create NEW non-recursive policies
CREATE POLICY "Users can view practice_members in their practices"
ON practice_members FOR SELECT
USING (
  practice_id IN (
    SELECT get_user_practice_ids(auth.uid())
  )
);

CREATE POLICY "Users can insert practice_members in their practices"
ON practice_members FOR INSERT
WITH CHECK (
  practice_id IN (
    SELECT get_user_practice_ids(auth.uid())
  )
);

CREATE POLICY "Users can update practice_members in their practices"
ON practice_members FOR UPDATE
USING (
  practice_id IN (
    SELECT get_user_practice_ids(auth.uid())
  )
);

CREATE POLICY "Service role can manage all practice_members"
ON practice_members FOR ALL
USING (auth.role() = 'service_role');

SELECT '‚úÖ RLS Recursion Fixed!' as status;
```

**Click "Run"** and you should see: `‚úÖ RLS Recursion Fixed!`

---

## Migration 2: Create Invitations System

**Copy and paste this entire script:**

(See file: `torsor-practice-platform/supabase/migrations/20251008_invitations_system.sql`)

Or run this shorter version:

```sql
-- Just copy the ENTIRE contents of:
-- torsor-practice-platform/supabase/migrations/20251008_invitations_system.sql
```

**Click "Run"** and you should see: `‚úÖ Full Invitation System Created!`

---

## Migration 3: Add CPD Configuration

**Copy and paste this entire script:**

(See file: `torsor-practice-platform/supabase/migrations/20251008_cpd_configuration.sql`)

Or run this shorter version:

```sql
-- Just copy the ENTIRE contents of:
-- torsor-practice-platform/supabase/migrations/20251008_cpd_configuration.sql
```

**Click "Run"** and you should see: `‚úÖ CPD Configuration System Created!`

---

## ‚úÖ Verification

After running all 3 migrations, run this query to verify:

```sql
SELECT 
  '1. Invitations table' as check_name,
  CASE WHEN EXISTS (SELECT 1 FROM information_schema.tables WHERE table_name = 'invitations')
    THEN '‚úÖ EXISTS' ELSE '‚ùå MISSING' END as status
UNION ALL
SELECT 
  '2. RLS Recursion fixed',
  CASE WHEN EXISTS (SELECT 1 FROM pg_proc WHERE proname = 'get_user_practice_ids')
    THEN '‚úÖ FIXED' ELSE '‚ùå NOT FIXED' END
UNION ALL
SELECT 
  '3. CPD Configuration',
  CASE WHEN EXISTS (
    SELECT 1 FROM information_schema.columns 
    WHERE table_name = 'practices' AND column_name = 'cpd_total_expected_hours'
  ) THEN '‚úÖ ADDED' ELSE '‚ùå MISSING' END
UNION ALL
SELECT 
  '4. CPD Progress View',
  CASE WHEN EXISTS (SELECT 1 FROM information_schema.views WHERE table_name = 'cpd_progress_view')
    THEN '‚úÖ EXISTS' ELSE '‚ùå MISSING' END;
```

**Expected output:**
```
‚úÖ 1. Invitations table - EXISTS
‚úÖ 2. RLS Recursion fixed - FIXED
‚úÖ 3. CPD Configuration - ADDED
‚úÖ 4. CPD Progress View - EXISTS
```

---

## üöÄ After Migrations Complete

### Test Invitation System
1. Refresh TORSOR (Cmd/Ctrl + Shift + R)
2. Go to **Team Management ‚Üí Team Invitations**
3. Click **"New Invitation"**
4. Should now work without errors! üéâ

### Configure CPD Settings
1. Go to **Team Management ‚Üí Admin Dashboard**
2. You'll see new CPD configuration section
3. Set your practice's CPD requirements:
   - **Total Expected CPD Hours**: e.g., 40 hours/year
   - **Determined Hours**: e.g., 20 hours (practice-mandated)
   - **Self-Allocated Hours**: e.g., 20 hours (member choice)

### Configure Resend Email
Don't forget to add your Resend API key to Railway:
```bash
VITE_RESEND_API_KEY=re_your_api_key_here
VITE_FROM_EMAIL=noreply@rpgcc.com
VITE_FROM_NAME=RPGCC Team Portal
```

---

## üìã What This Gives You

### Invitation System
- ‚úÖ Send email invitations to team members
- ‚úÖ Track invitation status (pending, accepted, expired)
- ‚úÖ Automatic reminders
- ‚úÖ Bulk CSV import
- ‚úÖ Event logging
- ‚úÖ Link generation for easy onboarding

### CPD Configuration
- ‚úÖ Set practice-wide CPD requirements
- ‚úÖ Split between determined and self-allocated hours
- ‚úÖ Track progress per team member
- ‚úÖ Real-time progress dashboard
- ‚úÖ Evidence tracking
- ‚úÖ Verification workflow

### No More Errors
- ‚úÖ No more `relation "public.invitations" does not exist`
- ‚úÖ No more `infinite recursion detected in policy`
- ‚úÖ Team invitations fully functional
- ‚úÖ Skills matrix shows real data only
- ‚úÖ CPD tracking linked to skills development

---

## üÜò Troubleshooting

### If invitations still don't work:
```sql
-- Check if table exists
SELECT COUNT(*) FROM invitations;
```

### If RLS recursion persists:
```sql
-- Check if functions exist
SELECT proname FROM pg_proc WHERE proname IN ('get_user_practice_ids', 'is_practice_member');
```

### If CPD fields are missing:
```sql
-- Check if columns exist
SELECT column_name FROM information_schema.columns 
WHERE table_name = 'practices' 
AND column_name LIKE 'cpd%';
```

---

## üéØ Next Steps

1. ‚úÖ Run all 3 migrations in Supabase
2. ‚úÖ Refresh TORSOR
3. ‚úÖ Test invitation system
4. ‚úÖ Configure CPD settings in Admin Dashboard
5. ‚úÖ Add Resend API key to Railway
6. ‚úÖ Start inviting your 16-person team!

**Let's get you live for Monday! üöÄ**


